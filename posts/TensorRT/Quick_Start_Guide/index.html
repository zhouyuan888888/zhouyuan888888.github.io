<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">

    <meta name="author" content="Yuan Zhou">
    <meta name="description" content='The quick start for TensorRT'>
    <meta name="keywords" content="blog, TensorRT">

<!--    <script data-ad-client="ca-pub-6193773296453862" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>-->
<!--    <meta name="twitter:card" content="summary"/>-->
<!--<meta name="twitter:title" content="Configure Ruby development"/>-->
<!--<meta name="twitter:description" content="rbenv # install rbenv, will also install ruby-build $ brew install rbenv # upgrade rbenv and ruby-build $ brew upgrade rbenv ruby-build # add `eval &#34;$(rbenv init -)&#34;` to your profile $ echo &#39;eval &#34;$(rbenv init -)&#34;&#39; &gt;&gt; ~/.zshrc # also need to add rbenv to PATH, if you have separate homebrew $ echo &#39;export PATH=~/homebrew/bin:$PATH&#39; &gt;&gt; ~/.zshrc # list latest stable versions $ rbenv install -l # list all local versions $ rbenv install -L # install a Ruby version $ rbenv install 3."/>-->

<!--    <meta property="og:title" content="Configure Ruby development" />-->
<!--<meta property="og:description" content="rbenv # install rbenv, will also install ruby-build $ brew install rbenv # upgrade rbenv and ruby-build $ brew upgrade rbenv ruby-build # add `eval &#34;$(rbenv init -)&#34;` to your profile $ echo &#39;eval &#34;$(rbenv init -)&#34;&#39; &gt;&gt; ~/.zshrc # also need to add rbenv to PATH, if you have separate homebrew $ echo &#39;export PATH=~/homebrew/bin:$PATH&#39; &gt;&gt; ~/.zshrc # list latest stable versions $ rbenv install -l # list all local versions $ rbenv install -L # install a Ruby version $ rbenv install 3." />-->
<!--<meta property="og:type" content="article" />-->
<!--<meta property="og:url" content="https://nkcoder.github.io/posts/ruby/configure-ruby-development/" />-->
<!--<meta property="article:published_time" content="2021-08-28T20:49:23+08:00" />-->
<!--<meta property="article:modified_time" content="2021-08-28T20:49:23+08:00" />-->
<!--      <base href="https://nkcoder.github.io/posts/ruby/configure-ruby-development/">-->
<!--    <title>-->
<!--  TensorRT Quick Start-->
<!--</title>-->
      <link rel="canonical" href="https://nkcoder.github.io/posts/ruby/configure-ruby-development/">
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.13.0/css/all.css" integrity="sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />
      <link rel="stylesheet" href="https://nkcoder.github.io/css/coder.min.65305c746ff138250bd5cf256e60457b6187a3dd0a4cb24e69143bafcfd28741.css" integrity="sha256-ZTBcdG/xOCUL1c8lbmBFe2GHo90KTLJOaRQ7r8/Sh0E=" crossorigin="anonymous" media="screen" />
      <link rel="stylesheet" href="https://nkcoder.github.io/css/custom.css" />
    <link rel="icon" type="image/png" href="https://nkcoder.github.io/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://nkcoder.github.io/img/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.80.0" />
  </head>
  <body class="colorscheme-light"
        onload=""
  >
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://zhouyuan888888.github.io/">
      Just Coding
    </a>
    
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">

          <li class="navigation-item">
            <a class="navigation-link" href="https://zhouyuan888888.github.io/posts/">Blog</a>
          </li>
<!--          <li class="navigation-item">-->
<!--            <a class="navigation-link" href="https://zhouyuan888888.github.io/categories/">Category</a>-->
<!--          </li>-->
<!--          <li class="navigation-item">-->
<!--            <a class="navigation-link" href="https://zhouyuan888888.github.io/tags/">Tag</a>-->
<!--          </li>-->
    </ul>
  </section>
</nav>
      <div class="content">
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Quick Start Guidance for TensorRT</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2022-08-28T20:49:23&#43;08:00'>
                july 16, 2022
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              1-minute read
            </span>
          </div>
          <div class="categories">
  <i class="fas fa-folder"></i>
    <a href="https://zhouyuan888888.github.io/categories/TensorRT/">TensorRT</a></div>
        </div>
      </header>
      <div>

        <h2 id="TensorRT Installation">TensorRT Installation</h2>
        <p> There are many different ways to install TensorRT, such as: </p>
        <ui>
          <li>using a container,</li>
          <li>using a Debian file,</li>
          <li> using a Tar file, and</li>
          <li>using a standalone pip wheel file,</li>
          <li>....</li>
        </ui>
        <p> However, in this blog, I am mainly focusing elaborating the steps about installing TensorRT through a Tar file in Anaconda virtual environment. Notice that I find installing TensorRT through pip wheel cannot directly use trtexec commond as there is no folder that contains trtexec files. The installation steps are presented as below:</p>

        <ui>
          <li>Check the version of CUDA toolkit and the python interpreter in Anaconda virtual environment. <span style="color:#6272a4">For example, my  <span style="color:#8be9fd;font-style:italic">CUDA toolkit version</span> is 10.2 and <span style="color:#8be9fd;font-style:italic">python interpreter</span> version is 3.6.13.  </span></li>
          <li>Download the corresponding TensorRT Tar file from <a href="https://developer.nvidia.com/nvidia-tensorrt-download">NVIDIA official website</a>. According to the version of  <span style="color:#8be9fd;font-style:italic">CUDA toolkit</span> and  <span style="color:#8be9fd;font-style:italic">python interpreter</span>, we download the <a href="https://developer.nvidia.com/compute/machine-learning/tensorrt/secure/7.1/tars/TensorRT-7.1.3.4.Ubuntu-16.04.x86_64-gnu.cuda-10.2.cudnn8.0.tar.gz">TensorRT 7.1.3.4 for Ubuntu 16.04 and CUDA 10.2 TAR package</a>. </li>
          <li>Install cudnn using the commond, ``conda cudnn==version'' according to the requirement of tar file.</li>
          <li>After that, we can install TensorRT through the Tar file according to  <a href="https://docs.nvidia.com/deeplearning/tensorrt/install-guide/index.html#installing-tar">official installation guidance.</a> </li>
          <li>Specially, as we want to install TensorRT in Anaconda  virtual environment, there are some additional operations should be conducted. (1) We cannot directly use trtexec command to convert Pytorch or TensorFlow models to onnx. We shuold add  <span style="color:#6272a4">export PATH=~/TensorRT-7.0.0.11/bin: \$PATH</span> and  <span style="color:#6272a4">export LD_LIBRARY_PATH =\$ LD_LIBRARY_PATH:~/TensorRT-7.0.0.11/lib:$LD_LIBRARY_PATH</span> into ~/.bashrc.  </li>
          <li>As cudnn is installed in virtual environment, we also should add the command <span style="color:#6272a4">export LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:~/anaconda2/envs/envs_name/lib:\$LD_LIBRARY_PATH</span> in ~/.bashrc. </li>
          <li>The use of TensorRT with Pytorch model can be summarized in the following: (1) converting Pytorch into onnx:
            <pre><code>
  resnet50 = models.resnet50(pretrained=True, progress=False).eval()
  BATCH_SIZE=32
  dummy_input=torch.randn(BATCH_SIZE, 3, 224, 224)
  torch.onnx.export(resnet50, dummy_input, "resnet50_pytorch.onnx", verbose=False)
            </code></pre>
          (2) using the commond ``trtexec'' to create the engine from the onnx file:
            <pre><code>
if USE_FP16:
  !trtexec --onnx=resnet50_pytorch.onnx --saveEngine=resnet_engine_pytorch.trt  --explicitBatch --inputIOFormats=fp16:chw --outputIOFormats=fp16:chw --fp16
else:
  !trtexec --onnx=resnet50_pytorch.onnx --saveEngine=resnet_engine_pytorch.trt  --explicitBatch
            </code></pre>
            (3) testing model using the engine:
            <pre><code>
import tensorrt as trt
import pycuda.driver as cuda
import pycuda.autoinit
import numpy as np

def predict(batch): # result gets copied into output
    # transfer input data to device
    cuda.memcpy_htod_async(d_input, batch, stream)
    # execute model
    context.execute_async_v2(bindings, stream.handle, None)
    # transfer predictions back
    cuda.memcpy_dtoh_async(output, d_output, stream)
    # syncronize threads
    stream.synchronize()

    return output

f = open("resnet_engine_pytorch.trt", "rb")
runtime = trt.Runtime(trt.Logger(trt.Logger.WARNING))
engine = runtime.deserialize_cuda_engine(f.read())
context = engine.create_execution_context()

# need to set input and output precisions to FP16 to fully enable it
output = np.empty([BATCH_SIZE, 1000], dtype = target_dtype)

# allocate device memory
d_input = cuda.mem_alloc(1 * input_batch.nbytes)
d_output = cuda.mem_alloc(1 * output.nbytes)

bindings = [int(d_input), int(d_output)]
stream = cuda.Stream()

print("Warming up...")
pred = predict(preprocessed_images)
print("Done warming up!")
pred = predict(preprocessed_images)
            </code></pre>


        </ui>

      </div>
      <footer>
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "nkcoder" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </footer>
    </article>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js" id="MathJax-script"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [
          ['$', '$'], ['\\(', '\\)']
        ],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  </section>
      </div>

  <footer class="footer">
    <section class="container">
        <p>Enjoy coding, friends!</p> © 2022 Yuan Zhou · Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
    </section>
  </footer>
    </main>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-168735975-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
  </body>
</html>
